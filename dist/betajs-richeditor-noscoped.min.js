/*!
betajs-richeditor - v1.0.9 - 2017-02-15
Copyright (c) Victor Lingenthal
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Dynamics.RichEditor"),a.binding("base","global:BetaJS"),a.binding("browser","global:BetaJS.Browser"),a.binding("dynamics","global:BetaJS.Dynamics"),a.binding("jquery","global:jQuery"),a.define("module:",function(){return{guid:"15a5c98c-e44a-cb29-7593-2577c3ce3753",version:"1.0.9"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("browser:version","~1.0.61"),a.assumeVersion("dynamics:version","~0.0.83"),a.define("module:Richeditor",["dynamics:Dynamic","jquery:","base:Strings","browser:Dom","browser:Events","browser:Selection","base:Objs","base:Types"],function(a,b,c,d,e,f,g,h,i){var j=a.extend({scoped:i},function(a){return{template:"<div></div>",constructor:function(b){a.constructor.call(this,b),this._domEvents=this.auto_destroy(new e),this.set("content",this.initialContent||""),this.__wasKeyInput=!1,this.__enableContentChange=!1,this.on("select",function(){this.trigger("element")}),this.on("change:content",function(a){this.editor()&&this.__enableContentChange&&(this.editor().innerHTML=a)},this),this.properties().computed("text",function(){return c.strip_html(this.get("content")||"")},["content"]),this._domEvents.on(window,"selectionchange",function(){this.hasFocus()&&this.trigger("select")},this),this.__caretElementStack={},this.on("select",function(){this.__caretClearElementStack()},this),this.on("keyinput",function(){this.__caretCharacterAdded()},this)},editor:function(){return d.unbox(this.activeElement())},_afterActivate:function(){var a=this.editor();a.contentEditable=!0,a.innerHTML=this.get("content"),this._domEvents.on(a,"blur",function(){this.trigger("leave")},this),this._domEvents.on(a,"focus",function(){this.trigger("enter")},this),this._domEvents.on(a,"keypress",function(a){this.__wasKeyInput=!1,0!==a.which&&(this.__wasKeyInput=!0)},this),this._domEvents.on(a,"input",function(a){this.__enableContentChange=!1,this.set("content",a.innerHTML),this.__enableContentChange=!0,this.__wasKeyInput&&(this.__wasKeyInput=!1,this.trigger("keyinput"))},this)},focus:function(){this.editor().focus()},caretNodeOffset:function(){return f.selectionEndOffset()},hasParentElement:function(a){return this.isSelected()?this.selectionHasParentElement(a):this.caretHasParentElement(a)},setParentElement:function(a,b){this.isSelected()?this.selectionSetParentElement(a,b):this.caretSetParentElement(a,b)},isSelected:function(){return f.selectionContained(this.editor())&&f.selectionNonEmpty()},selectionSetParentElement:function(a,b){if(this.isSelected()){var c=this.selectionHasParentElement(a);h.is_undefined(b)&&(b=!c),b!=c&&(b?this.selectionAddParentElement(a):this.selectionRemoveParentElement(a))}},caretSetParentElement:function(a,b){var c=this.caretHasParentElement(a);h.is_undefined(b)&&(b=!c),b!=c&&(b?this.caretAddParentElement(a):this.caretRemoveParentElement(a))},caretAddParentElement:function(a){this.caretHasParentElement(a)||(this.__caretElementStack[a]=!0,this.trigger("element"))},__caretClearElementStack:function(){this.__caretElementStack={}},caretRemoveParentElement:function(a){this.caretHasParentElement(a)&&(this.__caretElementStack[a]=!1,this.trigger("element"))},contentSiblings:function(a){var b=[];return a.parentNode.childNodes.forEach(function(c){c!=a&&b.push(c)}),b},selectionAncestor:function(){return f.selectionAncestor()},selectionLeaves:function(){return f.selectionLeaves()},selection:function(){return f.selectionNodes()},caretNode:function(){return f.selectionStartNode()},selectionRemoveParentElement:function(a){if(this.isSelected()){f.selectionSplitOffsets();var b=f.selectionNodes();b.forEach(function(b){this.remove_tag_from_parent_path(b,a,this.editor())},this),f.selectRange(b[0],b[b.length-1])}},hasFocus:function(){return document.activeElement==this.editor()||b(document.activeElement).parents(this.editor()).length>0},selectionHasParentElement:function(a){return this.isSelected()?b(this.selectionAncestor()).parents(b(this.editor()).find(a)).length>0?!0:g.all(this.selectionLeaves(),function(c){return b(c).closest(b(this.editor()).find(a)).length>0},this):!1},selectionAddParentElement:function(a){if(this.isSelected()){f.selectionSplitOffsets();for(var c=b(f.selectionNodes()),d=0;d<c.length;++d)0===c[d].closest(b(this.editor()).find(a)).length&&(c[d]=c[d].wrap("<"+a+"></"+a+">"));f.selectRange(c[0],c[c.length-1])}},caretHasParentElement:function(a){return h.is_defined(this.__caretElementStack[a])?this.__caretElementStack[a]:b(this.caretNode()).parents(b(this.editor()).find(a)).length>0},__caretCharacterAdded:function(){var a=[],c=[];g.iter(this.__caretElementStack,function(b,d){(b?a:c).push(d)});var e=d.splitNode(this.caretNode(),this.caretNodeOffset()-1,this.caretNodeOffset()),h=null;for(h=0;h<c.length;++h)this.remove_tag_from_parent_path(e,c[h],this.editor());for(h=0;h<a.length;++h)e=b(e).wrap("<"+a[h]+"></"+a[h]+">").get(0);f.selectNode(e,1)},remove_tag_from_parent_path:function(a,c,d){c=c.toLowerCase(),a=b(a),d=b(d);for(var e=a.parents(d?d+" "+c:c),f=0;f<e.length;++f){var g=e.get(f);for(g=b(g);a.get(0)!=g.get(0);)this.contentSiblings(a.get(0)).wrap("<"+c+"></"+c+">"),a=a.parent();g.contents().unwrap()}}}});return j.register("ba-richeditor"),j})}).call(Scoped);
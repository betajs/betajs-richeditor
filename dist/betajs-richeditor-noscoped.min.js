/*!
betajs-richeditor - v1.0.5 - 2016-11-06
Copyright (c) Victor Lingenthal
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Dynamics.RichEditor"),a.binding("base","global:BetaJS"),a.binding("browser","global:BetaJS.Browser"),a.binding("dynamics","global:BetaJS.Dynamics"),a.binding("jquery","global:jQuery"),a.define("module:",function(){return{guid:"15a5c98c-e44a-cb29-7593-2577c3ce3753",version:"35.1478470138131"}}),a.define("module:Richeditor",["dynamics:Dynamic","jquery:","base:Strings","browser:Dom","browser:Selection","base:Objs","base:Types"],function(a,b,c,d,e,f,g,h){var i=a.extend({scoped:h},function(a){return{template:"<div></div>",constructor:function(d){a.constructor.call(this,d),this.set("content",this.initialContent||""),this.__wasKeyInput=!1,this.__enableContentChange=!1,this.on("select",function(){this.trigger("element")}),this.on("change:content",function(a){this.editor()&&this.__enableContentChange&&this.$editor().html(a)},this),this.properties().computed("text",function(){return c.strip_html(this.get("content")||"")},["content"]);var e=this;b(window).on("selectionchange."+this.cid(),function(){e.hasFocus()&&e.trigger("select")}),this.__caretElementStack={},this.on("select",function(){this.__caretClearElementStack()},this),this.on("keyinput",function(){this.__caretCharacterAdded()},this)},destroy:function(){b(window).off("selectionchange."+this.cid()),a.destroy.call(this)},editor:function(){return this.element().get(0)},$editor:function(){return b(this.editor())},_afterActivate:function(a){$e=this.$editor(),$e.attr("contenteditable",!0),$e.html(this.get("content"));var b=this;$e.on("blur",function(){b.trigger("leave")}),$e.on("focus",function(){b.trigger("enter")}),$e.on("keypress",function(a){b.__wasKeyInput=!1,0!==a.which&&(b.__wasKeyInput=!0)}),$e.on("input",function(a){b.__enableContentChange=!1,b.set("content",$e.html()),b.__enableContentChange=!0,b.__wasKeyInput&&(b.__wasKeyInput=!1,b.trigger("keyinput"))})},hasFocus:function(){return document.activeElement==this.editor()||b(document.activeElement).parents(this.editor()).length>0},focus:function(){this.$editor().focus()},caretNodeOffset:function(){return e.selectionEndOffset()},hasParentElement:function(a){return this.isSelected()?this.selectionHasParentElement(a):this.caretHasParentElement(a)},setParentElement:function(a,b){this.isSelected()?this.selectionSetParentElement(a,b):this.caretSetParentElement(a,b)},isSelected:function(){return e.selectionContained(this.$editor().get(0))&&e.selectionNonEmpty()},selectionAncestor:function(){return b(e.selectionAncestor())},selection:function(){return b(e.selectionNodes())},selectionLeaves:function(){return b(e.selectionLeaves())},selectionHasParentElement:function(a){return this.isSelected()?this.selectionAncestor().parents(this.$editor().find(a)).length>0?!0:f.all(this.selectionLeaves(),function(b){return b.closest(this.$editor().find(a)).length>0},this):!1},selectionSetParentElement:function(a,b){if(this.isSelected()){var c=this.selectionHasParentElement(a);g.is_undefined(b)&&(b=!c),b!=c&&(b?this.selectionAddParentElement(a):this.selectionRemoveParentElement(a))}},selectionAddParentElement:function(a){if(this.isSelected()){e.selectionSplitOffsets();for(var c=b(e.selectionNodes()),d=0;d<c.length;++d)0===c[d].closest(this.$editor().find(a)).length&&(c[d]=c[d].wrap("<"+a+"></"+a+">"));e.selectRange(c[0],c[c.length-1])}},selectionRemoveParentElement:function(a){if(this.isSelected()){e.selectionSplitOffsets();for(var c=b(e.selectionNodes()),d=0;d<c.length;++d)this.remove_tag_from_parent_path(c[d],a,this.$editor());e.selectRange(c[0],c[c.length-1])}},caretNode:function(){return b(e.selectionStartNode())},caretHasParentElement:function(a){return g.is_defined(this.__caretElementStack[a])?this.__caretElementStack[a]:this.caretNode().parents(this.$editor().find(a)).length>0},caretSetParentElement:function(a,b){var c=this.caretHasParentElement(a);g.is_undefined(b)&&(b=!c),b!=c&&(b?this.caretAddParentElement(a):this.caretRemoveParentElement(a))},caretAddParentElement:function(a){this.caretHasParentElement(a)||(this.__caretElementStack[a]=!0,this.trigger("element"))},__caretCharacterAdded:function(){var a=[],c=[];f.iter(this.__caretElementStack,function(b,d){(b?a:c).push(d)});var g=b(d.splitNode(this.caretNode().get(0),this.caretNodeOffset()-1,this.caretNodeOffset())),h=null;for(h=0;h<c.length;++h)this.remove_tag_from_parent_path(g,c[h],this.$editor());for(h=0;h<a.length;++h)g=g.wrap("<"+a[h]+"></"+a[h]+">");e.selectNode(g.get(0),1)},__caretClearElementStack:function(){this.__caretElementStack={}},caretRemoveParentElement:function(a){this.caretHasParentElement(a)&&(this.__caretElementStack[a]=!1,this.trigger("element"))},contentSiblings:function(a){var b=[];return a.parentNode.childNodes.forEach(function(c){c!=a&&b.push(c)}),b},remove_tag_from_parent_path:function(a,c,d){c=c.toLowerCase(),a=b(a);for(var e=a.parents(d?d+" "+c:c),f=0;f<e.length;++f){var g=e.get(f);for(g=b(g);a.get(0)!=g.get(0);)this.contentSiblings(a.get(0)).wrap("<"+c+"></"+c+">"),a=a.parent();g.contents().unwrap()}}}});return i.register("ba-richeditor"),i})}).call(Scoped);
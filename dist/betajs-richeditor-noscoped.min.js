/*!
betajs-richeditor - v1.0.2 - 2016-02-10
Copyright (c) Victor Lingenthal
Apache 2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Dynamics.RichEditor"),a.binding("base","global:BetaJS"),a.binding("dynamics","global:BetaJS.Dynamics"),a.binding("browser","global:BetaJS.Browser"),a.binding("jquery","global:jQuery"),a.define("module:",function(){return{guid:"15a5c98c-e44a-cb29-7593-2577c3ce3753",version:"29.1455125701271"}}),a.define("module:Richeditor",["dynamics:Dynamic","jquery:","base:Strings","browser:Dom","base:Objs","base:Types"],function(a,b,c,d,e,f,g){var h=a.extend({scoped:g},function(a){return{template:"<div></div>",constructor:function(d){a.constructor.call(this,d),this.set("content",this.initialContent||""),this.__wasKeyInput=!1,this.__enableContentChange=!1,this.on("select",function(){this.trigger("element")}),this.on("change:content",function(a){this.editor()&&this.__enableContentChange&&this.$editor().html(a)},this),this.properties().computed("text",function(){return c.strip_html(this.get("content")||"")},["content"]);var e=this;b(window).on("selectionchange."+this.cid(),function(){e.hasFocus()&&e.trigger("select")}),this.__caretElementStack={},this.on("select",function(){this.__caretClearElementStack()},this),this.on("keyinput",function(){this.__caretCharacterAdded()},this)},destroy:function(){b(window).off("selectionchange."+this.cid()),a.destroy.call(this)},editor:function(){return this.element().get(0)},$editor:function(){return b(this.editor())},_afterActivate:function(a){$e=this.$editor(),$e.attr("contenteditable",!0),$e.html(this.get("content"));var b=this;$e.on("blur",function(){b.trigger("leave")}),$e.on("focus",function(){b.trigger("enter")}),$e.on("keypress",function(a){b.__wasKeyInput=!1,0!==a.which&&(b.__wasKeyInput=!0)}),$e.on("input",function(a){b.__enableContentChange=!1,b.set("content",$e.html()),b.__enableContentChange=!0,b.__wasKeyInput&&(b.__wasKeyInput=!1,b.trigger("keyinput"))})},hasFocus:function(){return document.activeElement==this.editor()||b(document.activeElement).parents(this.editor()).length>0},focus:function(){this.$editor().focus()},caretNodeOffset:function(){return d.selectionEndOffset()},hasParentElement:function(a){return this.isSelected()?this.selectionHasParentElement(a):this.caretHasParentElement(a)},setParentElement:function(a,b){this.isSelected()?this.selectionSetParentElement(a,b):this.caretSetParentElement(a,b)},isSelected:function(){return d.selectionContained(this.$editor())&&d.selectionNonEmpty()},selectionAncestor:function(){return d.selectionAncestor()},selection:function(){return d.selectionNodes()},selectionLeaves:function(){return d.selectionLeaves()},selectionHasParentElement:function(a){return this.isSelected()?this.selectionAncestor().parents(this.$editor().find(a)).length>0?!0:e.all(this.selectionLeaves(),function(b){return b.closest(this.$editor().find(a)).length>0},this):!1},selectionSetParentElement:function(a,b){if(this.isSelected()){var c=this.selectionHasParentElement(a);f.is_undefined(b)&&(b=!c),b!=c&&(b?this.selectionAddParentElement(a):this.selectionRemoveParentElement(a))}},selectionAddParentElement:function(a){if(this.isSelected()){d.selectionSplitOffsets();for(var b=d.selectionNodes(),c=0;c<b.length;++c)0===b[c].closest(this.$editor().find(a)).length&&(b[c]=b[c].wrap("<"+a+"></"+a+">"));d.selectRange(b[0],b[b.length-1])}},selectionRemoveParentElement:function(a){if(this.isSelected()){d.selectionSplitOffsets();for(var b=d.selectionNodes(),c=0;c<b.length;++c)d.remove_tag_from_parent_path(b[c],a,this.$editor());d.selectRange(b[0],b[b.length-1])}},caretNode:function(){return d.selectionStartNode()},caretHasParentElement:function(a){return f.is_defined(this.__caretElementStack[a])?this.__caretElementStack[a]:this.caretNode().parents(this.$editor().find(a)).length>0},caretSetParentElement:function(a,b){var c=this.caretHasParentElement(a);f.is_undefined(b)&&(b=!c),b!=c&&(b?this.caretAddParentElement(a):this.caretRemoveParentElement(a))},caretAddParentElement:function(a){this.caretHasParentElement(a)||(this.__caretElementStack[a]=!0,this.trigger("element"))},__caretCharacterAdded:function(){var a=[],b=[];e.iter(this.__caretElementStack,function(c,d){(c?a:b).push(d)});var c=d.splitNode(this.caretNode(),this.caretNodeOffset()-1,this.caretNodeOffset()),f=null;for(f=0;f<b.length;++f)d.remove_tag_from_parent_path(c,b[f],this.$editor());for(f=0;f<a.length;++f)c=c.wrap("<"+a[f]+"></"+a[f]+">");d.selectNode(c,1)},__caretClearElementStack:function(){this.__caretElementStack={}},caretRemoveParentElement:function(a){this.caretHasParentElement(a)&&(this.__caretElementStack[a]=!1,this.trigger("element"))}}});return h.register("ba-richeditor"),h})}).call(Scoped);
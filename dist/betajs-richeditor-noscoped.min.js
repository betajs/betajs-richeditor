/*!
betajs-richeditor - v1.0.10 - 2017-02-17
Copyright (c) Victor Lingenthal
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Dynamics.RichEditor"),a.binding("base","global:BetaJS"),a.binding("browser","global:BetaJS.Browser"),a.binding("dynamics","global:BetaJS.Dynamics"),a.define("module:",function(){return{guid:"15a5c98c-e44a-cb29-7593-2577c3ce3753",version:"1.0.10"}}),a.assumeVersion("base:version","~1.0.96"),a.assumeVersion("browser:version","~1.0.61"),a.assumeVersion("dynamics:version","~0.0.83"),a.define("module:Richeditor",["dynamics:Dynamic","base:Strings","browser:Dom","browser:Events","browser:Selection","base:Objs","base:Types"],function(a,b,c,d,e,f,g,h){var i=a.extend({scoped:h},function(a){return{template:"<div></div>",constructor:function(c){a.constructor.call(this,c),this._domEvents=this.auto_destroy(new d),this.set("content",this.initialContent||""),this.__wasKeyInput=!1,this.__enableContentChange=!1,this.on("select",function(){this.trigger("element")}),this.on("change:content",function(a){this.editor()&&this.__enableContentChange&&(this.editor().innerHTML=a)},this),this.properties().computed("text",function(){return b.strip_html(this.get("content")||"")},["content"]),this._domEvents.on(window,"selectionchange",function(){this.hasFocus()&&this.trigger("select")},this),this.__caretElementStack={},this.on("select",function(){this.__caretClearElementStack()},this),this.on("keyinput",function(){this.__caretCharacterAdded()},this)},editor:function(){return c.unbox(this.activeElement())},_afterActivate:function(){var a=this.editor();a.contentEditable=!0,a.innerHTML=this.get("content"),this._domEvents.on(a,"blur",function(){this.trigger("leave")},this),this._domEvents.on(a,"focus",function(){this.trigger("enter")},this),this._domEvents.on(a,"keypress",function(a){this.__wasKeyInput=!1,0!==a.which&&(this.__wasKeyInput=!0)},this),this._domEvents.on(a,"input",function(a){this.__enableContentChange=!1,this.set("content",a.innerHTML),this.__enableContentChange=!0,this.__wasKeyInput&&(this.__wasKeyInput=!1,this.trigger("keyinput"))},this)},focus:function(){this.editor().focus()},caretNodeOffset:function(){return e.selectionEndOffset()},hasParentElement:function(a){return this.isSelected()?this.selectionHasParentElement(a):this.caretHasParentElement(a)},setParentElement:function(a,b){this.isSelected()?this.selectionSetParentElement(a,b):this.caretSetParentElement(a,b)},isSelected:function(){return e.selectionContained(this.editor())&&e.selectionNonEmpty()},selectionSetParentElement:function(a,b){if(this.isSelected()){var c=this.selectionHasParentElement(a);g.is_undefined(b)&&(b=!c),b!=c&&(b?this.selectionAddParentElement(a):this.selectionRemoveParentElement(a))}},caretSetParentElement:function(a,b){var c=this.caretHasParentElement(a);g.is_undefined(b)&&(b=!c),b!=c&&(b?this.caretAddParentElement(a):this.caretRemoveParentElement(a))},caretAddParentElement:function(a){this.caretHasParentElement(a)||(this.__caretElementStack[a]=!0,this.trigger("element"))},__caretClearElementStack:function(){this.__caretElementStack={}},caretRemoveParentElement:function(a){this.caretHasParentElement(a)&&(this.__caretElementStack[a]=!1,this.trigger("element"))},contentSiblings:function(a){var b=[];return a.parentNode.childNodes.forEach(function(c){c!=a&&b.push(c)}),b},selectionAncestor:function(){return e.selectionAncestor()},selectionLeaves:function(){return e.selectionLeaves()},selection:function(){return e.selectionNodes()},caretNode:function(){return e.selectionStartNode()},selectionRemoveParentElement:function(a){if(this.isSelected()){e.selectionSplitOffsets();var b=e.selectionNodes();b.forEach(function(b){this.remove_tag_from_parent_path(b,a,this.editor())},this),e.selectRange(b[0],b[b.length-1])}},hasFocus:function(){for(var a=document.activeElement;a;){if(a==this.editor())return!0;a=a.parentElement}return!1},__caretCharacterAdded:function(){var a=[],b=[];f.iter(this.__caretElementStack,function(c,d){(c?a:b).push(d)});var d=c.splitNode(this.caretNode(),this.caretNodeOffset()-1,this.caretNodeOffset()),g=null;for(g=0;g<b.length;++g)this.remove_tag_from_parent_path(d,b[g],this.editor());for(g=0;g<a.length;++g){var h=document.createElement(a[g]);c.elementInsertBefore(h,d),h.appendChild(d),d=h}e.selectNode(d,1)},selectionHasParentElement:function(a){if(!this.isSelected())return!1;a=g.is_string(a)?this.editor().querySelector(a):a;for(var b=this.selectionAncestor();b;){if(b==a)return!0;if(b==this.editor())break;b=b.parentElement}return f.all(this.selectionLeaves(),function(b){for(;b;){if(b==a)return!0;if(b==this.editor())return!1;b=b.parentElement}return!1},this)},caretHasParentElement:function(a){if(g.is_defined(this.__caretElementStack[a]))return this.__caretElementStack[a];a=g.is_string(a)?this.editor().querySelector(a):a;for(var b=this.caretNode();b;){if(b==a)return!0;if(b==this.editor())break;b=b.parentElement}return!1},selectionAddParentElement:function(a){if(this.isSelected()){a=g.is_string(a)?this.editor().querySelector(a):a,e.selectionSplitOffsets();for(var b=e.selectionNodes(),d=0;d<b.length;++d){for(var f=b[d];f&&f!=a&&f!=this.editor();)f=f.parentElement;if(f!=a){var h=document.createElement(a);c.elementInsertBefore(h,b[d]),h.appendChild(b[d]),b[d]=h}}e.selectRange(b[0],b[b.length-1])}},remove_tag_from_parent_path:function(a,b,d){b=b.toLowerCase();for(var e=a.parentElement;e&&e!=this.editor()&&e!=d;){if(e.tagName.toLowerCase()===b){for(;a!=this.editor()&&a&&a!=e;)this.contentSiblings(a).forEach(function(a){var d=document.createElement(b);c.elementInsertBefore(d,a),d.appendChild(a)},this),a=a.parentElement;for(var f=[],g=0;g<e.childNodes.length;++g)f.push(e.childNodes[g]);f.forEach(function(a){for(;a.childNodes.length>0;)c.elementInsertBefore(a.childNodes[0],a);a.parentElement.removeChild(a)},this)}e=e.parentElement}}}});return i.register("ba-richeditor"),i})}).call(Scoped);
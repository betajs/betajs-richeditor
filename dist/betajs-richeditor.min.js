BetaJS.Templates.Cached=BetaJS.Templates.Cached||{},BetaJS.Templates.Cached["rich-editor-view-template"]='  <div class="rich-editor-view">    <div class="controlbox">       <div class="button" style="float: left"><div class="buttonicon icon ui-icon-power"></div></div>       <div class="button" style="float: left"><div class="buttonicon icon ui-icon-phone"></div></div>       <div class="button" style="float: left"><div class="buttonicon icon ui-icon-apple"></div></div>   </div>   <div class="editbox">   </div>  </div> ',BetaJS.Templates.Cached["simple-rich-editor-content-view-template"]='  <div class="simple-rich-editor-content-view" contenteditable="true" data-selector="inner" data-view-id="{%= supp.view_id %}">   {%= content %}  </div> ',BetaJS.Views.View.extend("BetaJS.Views.SimpleRichEditorContentView",{_templates:{"default":BetaJS.Templates.Cached["simple-rich-editor-content-view-template"]},constructor:function(a){this._inherited(BetaJS.Views.SimpleRichEditorContentView,"constructor",a),this._setOptionProperty(a,"content",""),this._selector="[data-view-id='"+this.cid()+"']",this.__wasKeyInput=!1,this.__enableContentChange=!1,this.on("select",function(){this.trigger("element")},this),this.on("change:content",function(a){this._editor&&this.__enableContentChange&&this._editor.html(a)},this),this.set("text",this.computed(function(){return BetaJS.Strings.strip_html(this.get("content")||"")},["content"]))},_global_events:[{selectionchange:"__select"}],_events:[{"blur [data-selector='inner']":"__leave","focus [data-selector='inner']":"__enter","input [data-selector='inner']":"__change","keypress [data-selector='inner']":"__keypress"}],__select:function(){this.hasFocus()&&this.trigger("select")},__leave:function(){this.trigger("leave")},__enter:function(){this.trigger("enter")},__change:function(){this.__enableContentChange=!1,this.set("content",this._editor.html()),this.__enableContentChange=!0,this.__wasKeyInput&&(this.__wasKeyInput=!1,this.trigger("keyinput"))},__keypress:function(a){this.__wasKeyInput=!1,0!==a.which&&(this.__wasKeyInput=!0)},_render:function(){this._inherited(BetaJS.Views.SimpleRichEditorContentView,"_render"),this._editor=this.$("[data-selector='inner']")},hasFocus:function(){return document.activeElement==this._editor.get(0)||BetaJS.$(document.activeElement).parents(this._selector).length>0},focus:function(){this._editor.focus()}}),BetaJS.Views.SimpleRichEditorContentView.extend("BetaJS.Views.RichEditorContentView",{constructor:function(a){this._inherited(BetaJS.Views.RichEditorContentView,"constructor",a),this.__caretElementStack={},this.on("select",function(){this.__caretClearElementStack()},this),this.on("keyinput",function(){this.__caretCharacterAdded()},this)},caretNodeOffset:function(){return BetaJS.Browser.Dom.selectionEndOffset()},hasParentElement:function(a){return this.isSelected()?this.selectionHasParentElement(a):this.caretHasParentElement(a)},setParentElement:function(a,b){this.isSelected()?this.selectionSetParentElement(a,b):this.caretSetParentElement(a,b)},isSelected:function(){return BetaJS.Browser.Dom.selectionContained(this._editor)&&BetaJS.Browser.Dom.selectionNonEmpty()},selectionAncestor:function(){return BetaJS.Browser.Dom.selectionAncestor()},selection:function(){return BetaJS.Browser.Dom.selectionNodes()},selectionLeaves:function(){return BetaJS.Browser.Dom.selectionLeaves()},selectionHasParentElement:function(a){return this.isSelected()?this.selectionAncestor().parents(this._selector+" "+a).length>0?!0:BetaJS.Objs.all(this.selectionLeaves(),function(b){return b.closest(this._selector+" "+a).length>0},this):!1},selectionSetParentElement:function(a,b){if(this.isSelected()){var c=this.selectionHasParentElement(a);BetaJS.Types.is_undefined(b)&&(b=!c),b!=c&&(b?this.selectionAddParentElement(a):this.selectionRemoveParentElement(a))}},selectionAddParentElement:function(a){if(this.isSelected()){BetaJS.Browser.Dom.selectionSplitOffsets();for(var b=BetaJS.Browser.Dom.selectionNodes(),c=0;c<b.length;++c)0===b[c].closest(this._selector+" "+a).length&&(b[c]=b[c].wrap("<"+a+"></"+a+">"));BetaJS.Browser.Dom.selectRange(b[0],b[b.length-1])}},selectionRemoveParentElement:function(a){if(this.isSelected()){BetaJS.Browser.Dom.selectionSplitOffsets();for(var b=BetaJS.Browser.Dom.selectionNodes(),c=0;c<b.length;++c)BetaJS.Browser.Dom.remove_tag_from_parent_path(b[c],a,this._selector);BetaJS.Browser.Dom.selectRange(b[0],b[b.length-1])}},caretNode:function(){return BetaJS.Browser.Dom.selectionStartNode()},caretHasParentElement:function(a){return BetaJS.Types.is_defined(this.__caretElementStack[a])?this.__caretElementStack[a]:this.caretNode().parents(this._selector+" "+a).length>0},caretSetParentElement:function(a,b){var c=this.caretHasParentElement(a);BetaJS.Types.is_undefined(b)&&(b=!c),b!=c&&(b?this.caretAddParentElement(a):this.caretRemoveParentElement(a))},caretAddParentElement:function(a){this.caretHasParentElement(a)||(this.__caretElementStack[a]=!0,this.trigger("element"))},__caretCharacterAdded:function(){var a=[],b=[];BetaJS.Objs.iter(this.__caretElementStack,function(c,d){(c?a:b).push(d)});var c=BetaJS.Browser.Dom.splitNode(this.caretNode(),this.caretNodeOffset()-1,this.caretNodeOffset()),d=null;for(d=0;d<b.length;++d)BetaJS.Browser.Dom.remove_tag_from_parent_path(c,b[d],this._selector);for(d=0;d<a.length;++d)c=c.wrap("<"+a[d]+"></"+a[d]+">");BetaJS.Browser.Dom.selectNode(c,1)},__caretClearElementStack:function(){this.__caretElementStack={}},caretRemoveParentElement:function(a){this.caretHasParentElement(a)&&(this.__caretElementStack[a]=!1,this.trigger("element"))}}),BetaJS.Views.ListContainerView.extend("BetaJS.Views.RichEditorView",{constructor:function(a){a=a||{},a.el="body",a.el_classes="rich-editor-view",a.alignment="vertical",this._inherited(BetaJS.Views.RichEditorView,"constructor",a),this._setOptionProperty(a,"content",""),this.ns.editor_view.on("element",function(){this.trigger("element-slow")},this,{min_delay:50,max_delay:200})},_domain:function(){return{toolbar:{type:"ListContainerView",options:{el_classes:"toolbar"}},bold_button:{type:"ButtonView",parent:"toolbar",options:{label:"B",children_classes:"bold",hotkey:"ctrl+b"},events:{click:function(){this.domain.ns.editor_view.focus(),this.domain.ns.editor_view.setParentElement("strong")}},listeners:{"element-slow":function(){this.set("selected",this.domain.ns.editor_view.hasParentElement("strong"))}}},italic_button:{type:"ButtonView",parent:"toolbar",options:{children_classes:"icon-italic",hotkey:"ctrl+i"},events:{click:function(){this.domain.ns.editor_view.focus(),this.domain.ns.editor_view.setParentElement("i")}},listeners:{"element-slow":function(){this.set("selected",this.domain.ns.editor_view.hasParentElement("i"))}}},underline_button:{type:"ButtonView",parent:"toolbar",options:{children_classes:"icon-underline"},events:{click:function(){this.domain.ns.editor_view.focus(),this.domain.ns.editor_view.setParentElement("u")}},listeners:{"element-slow":function(){this.set("selected",this.domain.ns.editor_view.hasParentElement("u"))}}},editor_view:{type:"BetaJS.Views.RichEditorContentView",el:".editbox",options:function(a){return{children_classes:"textareadiv",content:a.binding("content")}}}}}});